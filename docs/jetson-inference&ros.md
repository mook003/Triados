# Jetson-inference и ROS

## Подготовка

В данном разделе мы разберём как запускать нейронные сети глубокого обучения в нодах ROS

Для начала установите необходимые зависимости
```bash
sudo apt-get install ros-melodic-image-transport ros-melodic-vision-msgs
```

Перейдите в `catkin_ws/src` и клонируйте `ros_deep_learning`:

```bash
cd ~/catkin_ws/src
git clone https://github.com/dusty-nv/ros_deep_learning
```

Соберите и подготовте рабочее пространство

```bash
cd ~/catkin_ws/
catkin_make
source devel/setup.bash
```

## Запуск

Для начала запустите ядро ROS

```bash
roscore
```

Проверим возможность трансляции видеопотока:

```bash
roslaunch ros_deep_learning video_viewer.ros1.launch input:=v4l2:///dev/video0 output:=display://0
```

Вы должны увидеть окно с изображением, полученным от камеры 

### ImageNet

Следующая команда запустит `ImageNet`. Данная сеть обучена на базе данных из 1000 объектов, а её задача - определить объекты, которые находится на изображении.

```bash
roslaunch ros_deep_learning imagenet.ros1.launch input:=v4l2:///dev/video0 output:=display://0
```

В открывшемся окне вы можете также увидеть изображение с камеры, но теперь в левом верхнем углу находится строка с объектам. Первое значение - наибольшее значение уверенности среди всех найденных объектов; остальные - наименования классов объектов.

Также в терминале вы можете увидить информацию о всех объектах.

### DetectNet

Следующая сеть может не только определять объекты на изображении, но и строить ограничивающие рамки и указывать их положение

```bash
roslaunch ros_deep_learning detectnet.ros1.launch input:=v4l2:///dev/video0 output:=display://0
```

В новом окне все обнаруженные объекты будут выделяться ограничивающими рамками с указанием уверенности в определении объекта. В терминале Вы можете увидеть данные об объекте и его ограничивающей рамке.

### SegMet

Semantic Segmentation или cемантическая сегментация отличается от `DetectNet` тем, что классификация происходит на уровне пикселей, а не всего изображения.

```bash
roslaunch ros_deep_learning segnet.ros1.launch input:=v4l2:///dev/video0 output:=display://0
```

В последнем окне Вы можете увидеть, как нейронная сеть выделяет обнаруженные объекты цветами. Например, `SegMet` отдельно выделяет ноги, руки и голову человека. 

## Топики и параметры

Ниже приведены топики сообщений и параметры, которыми опирирует каждый узел.

### ImageNet Node

Топики

| Название топика | I/O | Тип сообщения | Описание |  
|-------------------|--------------|--------------|--------------|
|`image_in`|Ввод|[`sensor_msgs/Image`](http://docs.ros.org/en/melodic/api/sensor_msgs/html/msg/Image.html)|Необработанное входное изображение|
|`classification`|Вывод|[`vision_msgs/Classification2D`](http://docs.ros.org/en/melodic/api/vision_msgs/html/msg/Classification2D.html)|Результаты классификации (идентификатор класса + уверенность)|
|`vision_info`|Вывод|[`vision_msgs/VisionInfo`](http://docs.ros.org/en/melodic/api/vision_msgs/html/msg/VisionInfo.html)|Метаданные видения (название списка параметров меток классов)|
|`overlay`|Вывод|[`sensor_msgs/Image`](http://docs.ros.org/en/melodic/api/sensor_msgs/html/msg/Image.html)|Входное изображение c наложенными результатами классификации|

Параметры

| Название параметра | Тип | Значение по умолчанию | Описание | 
|-------------------|--------------|--------------|--------------|
|`model_name`|`строка`|`googlenet`|Имя встроенной модели (допустимые значения см. Здесь)|
|`model_path`|`строка`|`""`|Путь к пользовательской модели `caffe` или `ONNX`|
|`prototxt_path`|`строка`|`""`|Путь к пользовательскому файлу `caffe prototxt`|
|`input_blob`|`строка`|`data`|Имя входного слоя `DNN`|
|`output_blob`|`строка`|`prob`|Имя выходного слоя `DNN`|
|`class_labels_path`|`строка`|`""`|Путь к файлу пользовательских меток классов|
|`class_labels_HASH`|`vector<строка>`|class names|Список меток классов, где `HASH` зависит от модели (фактическое имя параметра можно найти в топике `vision_info`)|

### DetectMet Node

Топики

| Название топика | I/O | Тип сообщения | Описание |  
|-------------------|--------------|--------------|--------------|
|`image_in`|Ввод|[`sensor_msgs/Image`](http://docs.ros.org/en/melodic/api/sensor_msgs/html/msg/Image.html)|Необработанное входное изображение|
|`detections`|Вывод|[`vision_msgs/Detection2DArray`](http://docs.ros.org/melodic/api/vision_msgs/html/msg/Detection2DArray.html)|Результаты обнаружения (ограничительные рамки, идентификаторы классов, уверенность)|
|`vision_info`|Вывод|[`vision_msgs/VisionInfo`](http://docs.ros.org/en/melodic/api/vision_msgs/html/msg/VisionInfo.html)|Метаданные видения (название списка параметров меток классов)|
|`overlay`|Вывод|[`sensor_msgs/Image`](http://docs.ros.org/en/melodic/api/sensor_msgs/html/msg/Image.html)|Входное изображение c наложенными результатами классификации|

Параметры

| Название параметра | Тип | Значение по умолчанию | Описание |
|-------------------|--------------|--------------|--------------|
|`model_name`|`строка`|`"ssd-mobilenet-v2"`|Имя встроенной модели (допустимые значения см. Здесь)|
|`model_path`|`строка`|`""`|Путь к пользовательской модели `caffe` или `ONNX`|
|`prototxt_path	`|`строка`|`""`|Путь к пользовательскому файлу `caffe prototxt`|
|`input_blob`|`строка`|`data`|Имя входного слоя `DNN`|
|`output_cvg`|`строка`|`coverage`|Имя выходного слоя `DNN` (покрытие/баллы)|
|`output_bbox`|`строка`|`bboxes`|Имя выходного слоя `DNN` (ограничительные рамки)|
|`class_labels_path`|`строка`|`""`|Путь к файлу пользовательских меток классов|
|`class_labels_HASH`|`vector<строка>`|названия классов|Список меток классов, где `HASH` зависит от модели (фактическое имя параметра можно найти в разделе `vision_info`)|
|`overlay_flags`|`строка`|`none`,`box`,`labels`,`conf`|Флаги, используемые для создания наложения (некоторая комбинация `none`,`box`,`labels`,`conf`)|
|`mean_pixel_value`|`дробное значение`|`0.0`|Среднее значение вычитания пикселей, применяемое к входным данным (обычно 0)|
|`threshold`|`дробное значение`|`0.5`|Минимальное доверительное значение для положительных обнаружений (0,0 - 1,0)|

### SegMet Node

Топики

| Название топика | I/O | Тип сообщения | Описание |  
|-------------------|--------------|--------------|--------------|
|`image_in`|Ввод|[`sensor_msgs/Image`](http://docs.ros.org/en/melodic/api/sensor_msgs/html/msg/Image.html)|Необработанное входное изображение|
|`vision_info`|Вывод|[`vision_msgs/VisionInfo`](http://docs.ros.org/en/melodic/api/vision_msgs/html/msg/VisionInfo.html)|Метаданные видения (название списка параметров меток классов)|
|`overlay`|Вывод|[`sensor_msgs/Image`](http://docs.ros.org/en/melodic/api/sensor_msgs/html/msg/Image.html)|Входное изображение c наложенными результатами классификации|
|`color_mask`|Вывод|[`sensor_msgs/Image`](http://docs.ros.org/en/melodic/api/sensor_msgs/html/msg/Image.html)|Раскрашенная маска классов сегментации|
|`class_mask`|Вывод|[`sensor_msgs/Image`](http://docs.ros.org/en/melodic/api/sensor_msgs/html/msg/Image.html)|8-битное одноканальное изображение, где каждый пиксель является классификатором|

Параметры

| Название параметра | Тип | Значение по умолчанию | Описание |
|-------------------|--------------|--------------|--------------|
|`model_name`|`строка`|`"fcn-resnet18-cityscapes-1024x512"`|Имя встроенной модели (допустимые значения см. Здесь)|
|`model_path`|`строка`|`""`|Путь к пользовательской модели `caffe` или `ONNX`|
|`prototxt_path	`|`строка`|`""`|Путь к пользовательскому файлу `caffe prototxt`|
|`input_blob`|`строка`|`data`|Имя входного слоя `DNN`|
|`output_blob`|`строка`|`score_fr_21classes`|Имя выходного слоя `DNN`|
|`class_colors_path`|`строка`|`""`|Путь к файлу пользовательских цветов классов|
|`class_labels_path`|`строка`|`""`|Путь к файлу пользовательских меток классов|
|`class_labels_HASH`|`vector<строка>`|названия классов|Список меток классов, где `HASH` зависит от модели (фактическое имя параметра можно найти в разделе `vision_info`)|
|`mask_filter`|`строка`|`"linear"`|Фильтрация, применяемая к теме `color_mask` (`linear` или `point`)|
|`overlay_filter`|`строка`|`"linear"`|Фильтрация для применения к теме наложения (`linear` или `point`)|
|`overlay_alpha`|`дробное значение`|`180.0`|Значение альфа-наложения, используемое темой наложения (0.0 - 255.0)|

### video_source Node

Топики

| Название топика | I/O | Тип сообщения | Описание |  
|-------------------|--------------|--------------|--------------|
|`raw`|Вsвод|[`sensor_msgs/Image`](http://docs.ros.org/en/melodic/api/sensor_msgs/html/msg/Image.html)|Исходное изображение в формате Raw (BGR8)|


Параметры

| Название параметра | Тип | Значение по умолчанию | Описание | 
|`resource`|`строка`|`"csi://0"	`|URI входного потока (см. Здесь допустимые протоколы)|
|`codec`|`строка`|`""`|Вручную укажите кодек для сжатых потоков (допустимые значения см. Здесь)|
|`width`|`целое число`|0|Вручную укажите желаемую ширину видеопотокв (0 - поток по умолчанию)|
|`height`|`целое число`|0|Вручную укажите желаемую высоту видеопотокв (0 - поток по умолчанию)|
|`framerate`|`целое число`|0|Вручную укажите желаемую частоту кадров видеопотокв  (0 = поток по умолчанию)|
|`loop`|`целое число`|0|Для видеофайлов: 0 - не зацикливаться, больше 0 - количество циклов, -1 - постоянный цикл|
|`flip`|`строка`|`""`|Установите метод `flip` для камер `MIPI CSI` (допустимые значения см. Здесь|

### video_output Node

Топики

| Название топика | I/O | Тип сообщения | Описание |  
|-------------------|--------------|--------------|--------------|
|`image_in`|Ввод|[`sensor_msgs/Image`](http://docs.ros.org/en/melodic/api/sensor_msgs/html/msg/Image.html)|Необработанное входное изображение|

Параметры

| Название параметра | Тип | Значение по умолчанию | Описание |
|-------------------|--------------|--------------|--------------|
|`resource`|`строка`|`"display://0"	`|URI выходного видеопотока (см. Здесь допустимые протоколы)|
|`codec`|`строка`|`"h264"	`|Кодек, используемый для сжатых потоков (допустимые значения см. Здесь)|
|`bitrate`|`целое число`|4000000|Целевой битрейт `VBR` закодированных потоков (в битах в секунду)|


Ниже приведены темы сообщений и параметры, которые реализует каждый узел.
