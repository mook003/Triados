# MoveIt
Для расчёта кинематики манипулятора или же геометрии движения манипулятора относительно заданной системы координат, не рассматривая силы и моменты, порождающие это движение, мы будем использовать програмное обеспечение [MoveIt](https://moveit.ros.org). Оно создано для планирования движения, 3D восприятия, исключения столкновений с объектами и применяется во множдестве [роботов](https://moveit.ros.org/robots)

## Подготовка манипулятора

Для начала скачайте следующий [файл](https://github.com/mook003/Triados/tree/main/models/URDF/urdf_description) и распакуйте установленный архив в папку `.../catkin_ws/src/`

Данная папка содержит URDF (Universal Robot Description Format/ Универсальный Формат Описания Робота) файл и необходимые для него файлы и зависимости. Он содержит полное описание робота: 3D-модель, расположение соединений, массу элементов и их инерцию, материал и другие характеристики. Как редактировать и создавать новый URDF файл мы объесняем [здесь](https://www.youtube.com/watch?v=tkwmB6n3s_g) :x:

Приступим к созданию файла конфигурации. 

Запустите помощника по настройке MOVEit следующей командой:

```bash
roslaunch moveit_setup_assistant setup_assistant.launch
```

### Загрузка файлов

В открывшемся окне будут две действующие кнопки: `Create New MoveIt Configuration Package (Создать новый пакет конфигурации)` и `Edit Existing MoveIt Configuration Package (Редакитровать новый пакет конфигурации)` 

Нажмите на `Create New MoveIt Configuration Package`

<img src="https://github.com/mook003/Triados/blob/main/docs/setup_assistant_start.png" width="100%">

Нажмите на появившеюся кнопку `browse` и укажите путь к файлу `urdf.xacro`, расположенному в `.../catkin_ws/src/urdf_description/urdf/`, и загрузите файлы соответствующей кнопкой.

### Создание матрицы самоколлизий

На панели слева выберите `Self-Collisions` и нажмите `Generate Collision Matrix`, оставив `Sampling Density` по умолчанию.

<img src="https://github.com/mook003/Triados/blob/main/docs/setup_assistant_self_collisions.png" width="100%">

Данная процедура необходима для исключения пар связей от проверки столкновений для сокращения времени обработки планирования движения. Исключение может происходить на основе разных факторов: если пара всегда находится в столкновении, если соединения никогда не сталкиваются и прочие. `Sampling Density` влияет на то, сколько позиций будет проверено на самоколлизию. Большее значение данного свойства будет затрачивать больше времени на вычисления, а меньшие - может привести к исключению тех связей, которые не следует отключать.

### Добавление виртуальных соединений

Виртуальные суставы используются в основном для привязки робота к окружающему миру. Вам потребуется создать соединение между основанием манипулятора и `world frame`.

> **note:** Информацию о `world frame` и других фреймах Вы можете найти [здесь](https://www.youtube.com/watch?v=dQw4w9WgXcQ)  :x:

+ На панели слева выберите `Virtual Joints` и нажмите `Add Virtual Joint`
+ Укажите `Virtual Joint Name` как `virtual_joint`
+ Укажите основание манипулятора в качестве дочерней ссылки и мировой :x: как родительскую, установив `base_link` в `Child Link` и вписав `world` в `Parent Frame Name` 
+ Установите тип `Joint Type` как `fixed`
+ Нажмите `Save`

В итоге вы должны получить следующий результат:

<img src="https://github.com/mook003/Triados/blob/main/docs/setup_assistant_virtual_joints.png" width="100%">

### Добавление групп планирования

Для того, чтобы система понимала для каких элементов необходимо проводить вычисления, нужно создать группы планирования.

+ На панели слева выберите `Planning Groups`
+ Нажмите `Add Group`

<img src="https://github.com/mook003/Triados/blob/main/docs/setup_assistant_planning_groups_1.png" width="100%">

Для начала создадим группу планирования для руки:

+ Введите название группы в `Group Name`
> **note:**  Любой язык, кроме английского, может вызвать ошибки
+ Выберите `kdl_kinematics_plugin/KDLKinematicsPlugin` в качестве решателя кинематики (`kinematics solver`)
+ Оставьте `Kin. Search Resolution` и `Kin. Search Timeout` по умолчанию
+ Нажмите `Add Joints`, в появившемся окне выберите соединения `Rev1`, `Rev2` и `Rev3`, зажимая `Shift` и нажмите кнопку `>`
+ Нажмите `Save`

<img src="https://github.com/mook003/Triados/blob/main/docs/setup_assistant_planning_groups_2.png" width="100%">

Теперь добавим захват:

+ Нажмите `Add Group`
+ Введите название группы в `Group Name`
> **note:**  Любой язык, кроме английского, может вызвать ошибки
+ Остальные значения оставьте по умолчанию
+ Нажмите на `Add Links`
+ Выберите `hand_jaw_1_1` и `hand_jaw_2_1` и добавьте их в группу
+ Нажмите `Save`

<img src="https://github.com/mook003/Triados/blob/main/docs/setup_assistant_planning_groups_3.png" width="100%">

### Добавление поз робота

Вы можете добавлять определённые фиксированные позы. Например, вы можете добавить исходное положение или позицию для каких-либо сценариев

+ Выберите на панели `Robot Poses`
+ Нажмите `Add Poses`
+ Укажите название позы
+ Двигая слайдеры, выберите необходимую позу
+ Нажмите `Save`

> **note:**  позы создаются для определённых групп планирования

<img src="https://github.com/mook003/Triados/blob/main/docs/setup_assistant_robot_poses.png" width="100%">

### Конечные эффекторы

Теперь нужно обозначить группу захвата как специальную группу. Над группами, которые являются конечными эффекторами, можно выполнять специальные операции

+ Выберите на панели `End Effectors`
+ Нажмите ` Add End Effector`
+ Укажите название конечного эффектора
+ В `End Effector Group` укажите название группы планирования захвата
+ Выберите `hand_joint_1` в качестве `Parent Link`
+ `Parent Link` оставьте по умолчанию

<img src="https://github.com/mook003/Triados/blob/main/docs/setup_assistant_end_effectors.png" width="100%">

### Добавление пассивных соединений

В разделе `Passive Joints` вы можете добавить соединения, которые не могут управляться роботом, а значит решатель кинематики не сможет планировать движение данного сустава. В нашем манипуляторе нет пассивных соединений, поэтому мы пропустим этот шаг

### 3D восприятие

В разделе `3D Perception` Вы можете настроить карту занятости. Благодаря этому MoveIt сможет строить делать расчёты, избегая столкновения с окружающим миром. Система может принимать как карты глубин, так и облака точек. Мы будем использовать облака точек, так как это более эффективно.

+ Выберите на панели `3D Perception`
+ Измените значение `None` на `Point Cloud`
+ Укажите топик для прослушивания, задав значение `/zed2/zed_node/point_cloud/cloud_registered` в `Point Cloud Topic`
+ Остальные значения оставьте по умолчанию

Следующие настройки вы можете подобрать для себя:
> **note:** Изменение данных параметров может привести как к увеличению, так и к уменьшению производительности 

1. `Max Range:` Точки, превышающие это значение (в м), использоваться не будут

2. `Point Subsample:` Характеризует выборку из полученных точек. Значение `1` означает, что все точки будут задействованы

2. `Padding Offset:` Размер отступа (в см)

3. `Padding Scale:` Масштаб заполнения

4. `Filtered Cloud Topic` Топик, по которому будет опубликовано отфильтрованное облако (для отладки) 

5. `Max Update Rate:` Частота, с которой карта будет обновляться

<img src="https://github.com/mook003/Triados/blob/main/docs/setup_assistant_3d_perception.png" width="100%">

Также после сборки файла конфигурации будет создан файл `sensor_manager.launch.xml` в `<конфигурация манипулятора>/launch/`. В нём содержатся несколько дополнительных настроек:

1. `octomap_frame:` фрейм карты 

2. `octomap_resolution:` Задаёт разрешение карты (в м)

3. `max_range value:` Задаёт максимальное значение, оторое будет применяться для любого ввода датчика на эту ноду.

> **note:** В данном файле все значения нужно вводить внутри двойных кавычек после `value=`

### Cимуляция Gazebo

Подробнее о Gazebo мы будем говорить [здесь](https://vk.com/someonerex) :x:

### Управление ROS

`ROS Control` - набор пакетов, которые включают интерфейсы контроллеров, диспетчеры контроллеров, передатчики и аппаратные интерфейсы. Это позволяет внедрять разнообразные датчики, например для контроля положения или усилия. В данном руководстве мы рассмотрим добавление контроллера положения соединений

+ Выберите на панели `ROS Control`
+ Нажмите `Add Controller` 
+ Введите имя контроллера в `Controller Name`
+ Укажите `position_controllers/JointPositionController` в `Controller Type`
+ Нажмите `Add Planning Group Joints`
+ Добавьте группу планирования руки и нажмите `Save`
> **note:** Вы также можете добавлять соединения по отдельности через `Add Individual Joints`

<img src="https://github.com/mook003/Triados/blob/main/docs/setup_assistant_ros_controllers.png" width="100%">

### Добавление информации об авторе

+ Выберите на панели `Author Information`
+ Введите в соответствующие поля Ваши имя и почту

<img src="https://github.com/mook003/Triados/blob/main/docs/setup_assistant_author.png" width="100%">

### Создание файла конфигурации

Последний этап!

+ Выберите на панели `Configuration Files`
+ Нажмите `Browse`
+ В новом окне перейдите в `.../catkin_ws/src/`, нажмите на кнопку создания новой папки (в правом верхнем углу) и введите её название
+ Нажмите `Generate Package` и ожидайте

После сборки вы можете закрыть прогрмму кнопкой `Exit Setup Assistant`

<p align="right">Next | <b><a href="platform.md">Сборка подвижной платформы</a></b>
<br/>
Back | <b><a href="manipulator_manual.md">Сборка манипулятора</a></b></p>

<p align="right">
<p align="center"><sup>2021-2022 TRIADOS | </sup><a href="../README.md#содержание"><sup>Содержание</sup></a></p>
